name: LiTV Daily Update

# Ëß¶ÂèëËßÑÂàô
on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 3,12,21 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up date
      id: date
      run: |
        echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Update Files
      run: |
        # ÂàõÂª∫‰∏¥Êó∂ÁõÆÂΩï
        mkdir -p temp_files
        
        # ‰∏ãËΩΩÂü∫Á°ÄÊ∫êÊñá‰ª∂
        wget -q https://raw.githubusercontent.com/mursor1985/LIVE/main/iptv.m3u -O temp_files/Base1.m3u
        wget -q https://raw.githubusercontent.com/suxuang/myIPTV/main/ipv4.m3u -O temp_files/Base2.m3u
        
        # ÂêàÂπ∂Âπ∂ÂéªÈáçÂü∫Á°ÄÊ∫ê
        cat temp_files/Base1.m3u temp_files/Base2.m3u | awk '!seen[$0]++' > temp_files/Base.m3u
        
        # Â§ÑÁêÜÂ§ÆËßÜÊ∫ê
        grep -A 1 'Â§ÆËßÜ' temp_files/Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > temp_files/CCTV.m3u
        
        # Â§ÑÁêÜÈùûÂ§ÆËßÜÊ∫ê
        grep -v -A 1 'Â§ÆËßÜ' temp_files/Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > temp_files/CNTV.m3u
        
        # ÁîüÊàêM3UÊñá‰ª∂ÔºåÂú®Â§¥ÈÉ®Ê∑ªÂä†ÂÖ®Â±ÄÁî®Êà∑‰ª£ÁêÜËÆæÁΩÆ
        echo '#EXTVLCOPT:http-user-agent=okHttp/Mod-1.3.0.0' > LiTV.m3u
        echo '#EXTM3U' >> LiTV.m3u
        
        # Ê∑ªÂä†Ëá™ÂÆö‰πâÊèêÁ§∫ (Ê∏©È¶®ÊèêÁ§∫)
        echo '#EXTINF:-1 tvg-id="Ê∏©È¶®ÊèêÁ§∫" tvg-name="Ê∏©È¶®ÊèêÁ§∫" tvg-logo="https://logo.5iclub.dpdns.org/tv/Ê∏©È¶®ÊèêÁ§∫.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Ê∏©È¶®ÊèêÁ§∫' >> LiTV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >> LiTV.m3u
        
        # Ê∑ªÂä†Êñ∞Â¢ûÊèêÁ§∫ (Ë∞®Èò≤ËØàÈ™ó)
        echo '#EXTINF:-1 tvg-id="Ë∞®Èò≤ËØàÈ™ó" tvg-name="Ë∞®Èò≤ËØàÈ™ó" tvg-logo="https://logo.5iclub.dpdns.org/tv/Ë∞®Èò≤ËØàÈ™ó.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Ë∞®Èò≤ËØàÈ™ó' >> LiTV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >> LiTV.m3u
        
        # Ê∑ªÂä†Êñ∞Â¢ûÊèêÁ§∫ (Á¶ÅÊ≠¢ËïâÁªø)
        echo '#EXTINF:-1 tvg-id="Á¶ÅÊ≠¢ËïâÁªø" tvg-name="Á¶ÅÊ≠¢ËïâÁªø" tvg-logo="https://logo.5iclub.dpdns.org/tv/Á¶ÅÊ≠¢ËïâÁªø.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Á¶ÅÊ≠¢ËïâÁªø' >> LiTV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >> LiTV.m3u
        
        # ÂêàÂπ∂Ê∫êÊñá‰ª∂
        cat temp_files/CCTV.m3u temp_files/CNTV.m3u >> LiTV.m3u

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Ê∑ªÂä†Êñá‰ª∂
        git add LiTV.m3u

        # Êèê‰∫§Êõ¥Êîπ
        git commit -m "Automatic update at ${{ steps.date.outputs.date }}"
        
    - name: Fetch remote changes
      run: |
        git pull --allow-unrelated_histories -u origin main
        echo "Fetched remote changes before pushing"

    - name: Push Update
      run: |
        git push origin main --force-with-lease
