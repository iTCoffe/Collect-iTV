name: IPTV Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 3,12,21 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Cache
      uses: actions/cache@v4
      with:
        path: ~/.npm-packages
        key: ${{ runner.os }}-node
        restore-keys: |
          ${{ runner.os }}-node=

    - name: Get Current Time
      id: date
      run: |
        echo "date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB/OUTPUTS

    - name: Setup Environment
      run: |
        export TZ=Asia/Shanghai
        export upstream_url="https://raw.githubusercontent.com/suxuang/myIPTV/main/ipv4.m3u"

    - name: Download Base Source
      run: |
        wget -q "$upstream_url"

    - name: Merge Sources
      run: |
        cat Base1.m3u | awk '!seen[$0]++' > Base.m3u

    - name: Extract CCTV Sources
      run: |
        grep -A 1 'å¤®è§†' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > CCTV.m3u

    - name: Process Non-CCTV Sources
      run: |
        grep -v -A 1 'å¤®è§†' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > Other.m3u

    - name: Create M3U File
      run: |
        echo '#EXTM3U x-tvg-url="https://itv.jsdelivr.dpdns.org/epg.xml" catchup="append" catchup-source="?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}"' > LiTV.m3u
        echo '#EXTVLCOPT:http-user-agent=okHttp/Mod-1.3.0.0' >> LiTV.m3u

    - name: Add Custom Notice
      run: |
        echo '#EXTINF:-1 tvg-id="notice" tvg-logo="https://logo.5iclub.dpdns.org/tv/notice.png" group-title="ðŸ“¢ Notice",Notice' >> LiTV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/notice.mp4' >> LiTV.m3u

    - name: Merge Sources
      run: |
        cat CCTV.m3u Other.m3u >> LiTV.m3u

    - name: Generate TXT Playlist
      run: |
        awk '/^#EXTINF:/ {
          split($0, a, ",");
          name = a[2];
          getline url;
          gsub(/\r/, "", name);
          gsub(/\r/, "", url);
          sub(/^ /, "", name);
          print name "," url;
        }' LiTV.m3u | awk '!seen[$0]++' > LiTV.txt

    - name: Cleanup
      run: |
        rm -f Base1.m3u Base.m3u CCTV.m3u Other.m3u

    - name: Update README
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        cat <<EOF > README.md
        # IPTV Automatic Playlist
        Updated: ${{ steps.date.outputs.date }}
        
        ## Included Sources:
        - Main IPTV Playlist (M3U): [Download Here](https://github.com/your-repo/LiTV.m3u)
        - TXT Playlist: [Download Here](https://github.com/your-repo/LiTV.txt)
        EOF

    - name: Commit Changes
      run: |
        git add LiTV.m3u LiTV.txt README.md
        git commit -m "Update - ${{ steps.date.outputs.date }}"
        git tag -a "Update-$(date -u +'%Y%m%d')" -m "Automatic Update"

    - name: Push Changes
      run: |
        git push --set-upstream origin HEAD --force
        git push --tags
