name: MiGu Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */2 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: GetTime
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Update Files
      run: |
        echo "======= å¼€å§‹ä¸‹è½½å’Œå¤„ç†IPTVæºæ–‡ä»¶ ======="
        
        # 1. ä¸‹è½½åŸºç¡€æºæ–‡ä»¶
        echo "1. ä¸‹è½½æºæ–‡ä»¶..."
        wget -q "https://bc.188766.xyz/?url=https://live.ottiptv.cc" -O Base1.m3u
        
        # 2. ç»Ÿä¸€ç¼–ç å¹¶åˆæ­¥å»é‡
        echo "2. ç¼–ç ç»Ÿä¸€å’ŒåŸºç¡€å»é‡..."
        # è½¬æ¢ä¸ºUnixè¡Œå°¾å¹¶å»é™¤BOM
        sed -i 's/\r$//' Base1.m3u
        sed -i '1s/^\xEF\xBB\xBF//' Base1.m3u
        
        # 3. ä¸»å»é‡å‡½æ•° - åŸºäºURLå’Œåç§°åŒé‡å»é‡
        deduplicate_m3u() {
          local input_file=$1
          local output_file=$2
          
          # ä½¿ç”¨å…³è”æ•°ç»„å‚¨å­˜å·²çœ‹åˆ°çš„URLå’Œé¢‘é“åç»„åˆ
          awk '
          BEGIN {
            FS=","
            seen_url[""] = 0
            seen_name[""] = 0
            last_extinf = ""
            last_url = ""
            output_lines = ""
          }
          
          # EXTINFè¡Œå¤„ç†
          /^#EXTINF:-1/ {
            full_line = $0
            channel_name = ""
            
            # æå–é¢‘é“åç§°ï¼ˆæœ€åä¸€ä¸ªé€—å·åçš„å†…å®¹ï¼‰
            for(i=1; i<=NF; i++) {
              if(i == NF) {
                channel_name = $i
              }
            }
            
            # æå–tvg-id
            tvg_id = ""
            if(match($0, /tvg-id="([^"]*)"/, arr)) {
              tvg_id = arr[1]
            }
            
            last_extinf = full_line
            last_name = channel_name
            next
          }
          
          # URLè¡Œå¤„ç†ï¼ˆéæ³¨é‡Šã€éç©ºè¡Œã€éæ–‡ä»¶å¤´ï¼‰
          /^http/ && last_extinf != "" {
            url = $0
            key = url "|" last_name
            
            # å¦‚æœURLæˆ–é¢‘é“åå·²å­˜åœ¨ï¼Œè·³è¿‡
            if(!(key in seen_url) && !(last_name in seen_name)) {
              seen_url[key] = 1
              seen_name[last_name] = 1
              
              # è¾“å‡ºç»„åˆ
              output_lines = output_lines last_extinf "\n" url "\n"
            }
            
            last_extinf = ""
            last_name = ""
            last_url = ""
            next
          }
          
          # æ–‡ä»¶å¤´å’Œå…¶ä»–å…ƒæ•°æ®è¡Œ
          /^#EXTM3U/ {
            print $0 > "'"$output_file"'"
            next
          }
          
          # å…¶ä»–æ³¨é‡Šè¡Œï¼ˆç›´æ¥ä¿ç•™ï¼‰
          /^#/ && !/^#EXTINF/ {
            print $0 > "'"$output_file"'"
            next
          }
          
          # å¤„ç†æœ€åä¸€æ‰¹æ•°æ®
          END {
            print output_lines > "'"$output_file"'"
          }
          ' "$input_file"
        }
        
        # 4. åº”ç”¨ä¸»å»é‡
        echo "3. æ‰§è¡Œä¸»å»é‡é€»è¾‘..."
        deduplicate_m3u Base1.m3u Base_deduped.m3u
        
        # 5. åˆ†ç¦»å¤®è§†å’Œéå¤®è§†æºï¼ˆåœ¨å»é‡åŸºç¡€ä¸Šï¼‰
        echo "4. åˆ†ç¦»å¤®è§†å’Œéå¤®è§†é¢‘é“..."
        grep -A 1 -i 'å¤®è§†\|CCTV' Base_deduped.m3u | grep -v '^--$' > CCTV_base.m3u
        grep -v -A 1 -i 'å¤®è§†\|CCTV' Base_deduped.m3u | grep -v '^--$' > NonCCTV_base.m3u
        
        # 6. é¢‘é“åç§°è§„èŒƒåŒ–å»é‡
        normalize_channels() {
          local input_file=$1
          local output_file=$2
          
          awk '
          BEGIN {
            last_extinf = ""
            last_url = ""
            name_map[""] = 0
          }
          
          /^#EXTINF:-1/ {
            last_extinf = $0
            next
          }
          
          /^http/ && last_extinf != "" {
            # æå–è§„èŒƒåŒ–åç§°ï¼ˆå»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œç»Ÿä¸€å¤§å°å†™ï¼‰
            normalized = tolower(last_extinf)
            gsub(/[^a-z0-9\u4e00-\u9fa5]/, "", normalized)
            
            if(!(normalized in name_map)) {
              name_map[normalized] = 1
              print last_extinf >> "'"$output_file"'"
              print $0 >> "'"$output_file"'"
            }
            last_extinf = ""
            last_url = ""
          }
          ' "$input_file"
        }
        
        echo "5. é¢‘é“åç§°è§„èŒƒåŒ–å»é‡..."
        > CCTV_normalized.m3u
        > NonCCTV_normalized.m3u
        normalize_channels CCTV_base.m3u CCTV_normalized.m3u
        normalize_channels NonCCTV_base.m3u NonCCTV_normalized.m3u
        
        # 7. è¿‡æ»¤ç‰¹å®šå†…å®¹ï¼ˆé»‘åå•ï¼‰
        echo "6. åº”ç”¨é»‘åå•è¿‡æ»¤..."
        grep -v -E -i 'å†°èŒ¶ä½“è‚²|ğŸ€å†°èŒ¶å…¬å‘Š|æˆäºº|èµŒåš|è¯ˆéª—' CCTV_normalized.m3u > CCTV_filtered.m3u
        grep -v -E -i 'å†°èŒ¶ä½“è‚²|ğŸ€å†°èŒ¶å…¬å‘Š|æˆäºº|èµŒåš|è¯ˆéª—' NonCCTV_normalized.m3u > NonCCTV_filtered.m3u
        
        # 8. URLé»‘åå•è¿‡æ»¤
        echo "7. åº”ç”¨URLé»‘åå•..."
        grep -v -E 'https?://188766\.xyz/(dong|qiu|yu|pao)' CCTV_filtered.m3u > CCTV_final.m3u
        grep -v -E 'https?://188766\.xyz/(dong|qiu|yu|pao)' NonCCTV_filtered.m3u > NonCCTV_final.m3u
        
        # 9. ç”Ÿæˆæœ€ç»ˆM3Uæ–‡ä»¶
        echo "8. ç”Ÿæˆæœ€ç»ˆM3Uæ–‡ä»¶..."
        
        # æ–‡ä»¶å¤´
        echo '#EXTM3U x-tvg-url="https://itv.ifanr.netlib.re/epg.xml" catchup="append" catchup-source="?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}"' > MiGu.m3u
        echo '#' >> MiGu.m3u
        echo '# æœ€åæ›´æ–°: '$(date +'%Y-%m-%d %H:%M:%S') >> MiGu.m3u
        echo '# æ€»é¢‘é“æ•°: CCTV: '$(grep -c '^#EXTINF' CCTV_final.m3u)' | å…¶ä»–: '$(grep -c '^#EXTINF' NonCCTV_final.m3u) >> MiGu.m3u
        echo '#' >> MiGu.m3u
        
        # æ·»åŠ æ¸©é¦¨æç¤ºé¢‘é“
        echo '#EXTINF:-1 tvg-id="æ¸©é¦¨æç¤º" tvg-name="æ¸©é¦¨æç¤º" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/æ¸©é¦¨æç¤º.png" group-title="ğŸ¦§æ¸©é¦¨æç¤º",æ¸©é¦¨æç¤º' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u
        
        echo '#EXTINF:-1 tvg-id="è°¨é˜²è¯ˆéª—" tvg-name="è°¨é˜²è¯ˆéª—" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/è°¨é˜²è¯ˆéª—.png" group-title="ğŸ¦§æ¸©é¦¨æç¤º",è°¨é˜²è¯ˆéª—' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u
        
        echo '#EXTINF:-1 tvg-id="ç¦æ­¢è•‰ç»¿" tvg-name="ç¦æ­¢è•‰ç»¿" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/ç¦æ­¢è•‰ç»¿.png" group-title="ğŸ¦§æ¸©é¦¨æç¤º",ç¦æ­¢è•‰ç»¿' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u
        
        # åˆå¹¶é¢‘é“
        cat CCTV_final.m3u NonCCTV_final.m3u >> MiGu.m3u
        
        # 10. æœ€ç»ˆå…¨å±€å»é‡ï¼ˆä¿é™©æªæ–½ï¼‰
        echo "9. æœ€ç»ˆå…¨å±€å»é‡..."
        awk '
        BEGIN {
          last_extinf = ""
          url_map[""] = 0
        }
        
        /^#EXTINF:-1/ {
          last_extinf = $0
          next
        }
        
        /^http/ && last_extinf != "" {
          if(!($0 in url_map)) {
            url_map[$0] = 1
            print last_extinf
            print $0
          }
          last_extinf = ""
        }
        
        !/^#EXTINF:-1/ && !/^http/ {
          print $0
        }
        ' MiGu.m3u > MiGu_deduplicated.m3u
        mv MiGu_deduplicated.m3u MiGu.m3u
        
        # 11. ç”ŸæˆTXTæ’­æ”¾åˆ—è¡¨ï¼ˆå¸¦æœ€ç»ˆå»é‡ï¼‰
        echo "10. ç”ŸæˆTXTæ’­æ”¾åˆ—è¡¨..."
        awk '
        BEGIN {
          FS=","
          seen_combinations[""] = 0
        }
        
        /^#EXTINF:-1/ {
          full_line = $0
          channel_name = ""
          
          # æå–æœ€åä¸€ä¸ªé€—å·åçš„é¢‘é“åç§°
          for(i=1; i<=NF; i++) {
            if (i == NF) {
              channel_name = $i
              gsub(/^\s+|\s+$/, "", channel_name)
            }
          }
          
          getline url
          
          # æ¸…ç†URL
          gsub(/\r/, "", url)
          gsub(/^\s+|\s+$/, "", url)
          
          # ç»„åˆé”®ï¼ˆåç§°+URLçš„MD5å“ˆå¸Œç®€åŒ–ç‰ˆï¼‰
          if (channel_name != "" && url != "" && url ~ /^https?:\/\//) {
            # åˆ›å»ºç®€åŒ–çš„ç»„åˆé”®
            combination = channel_name "|" url
            simplified_key = ""
            
            # åªå–å‰50ä¸ªå­—ç¬¦ä½œä¸ºå»é‡é”®ï¼ˆé¿å…å†…å­˜è¿‡å¤§ï¼‰
            len = length(combination)
            if (len > 50) len = 50
            simplified_key = substr(combination, 1, len)
            
            if (!(simplified_key in seen_combinations)) {
              seen_combinations[simplified_key] = 1
              print channel_name "," url
            }
          }
        }
        ' MiGu.m3u | sort -u -t ',' -k1,1 > MiGu.txt
        
        # 12. ç»Ÿè®¡ä¿¡æ¯
        echo "======= å¤„ç†å®Œæˆ ======="
        echo "æœ€ç»ˆM3Uæ–‡ä»¶é¢‘é“æ•°: $(grep -c '^#EXTINF' MiGu.m3u)"
        echo "TXTæ–‡ä»¶è¡Œæ•°: $(wc -l < MiGu.txt)"
        echo "CCTVé¢‘é“æ•°: $(grep -c '^#EXTINF' CCTV_final.m3u)"
        echo "å…¶ä»–é¢‘é“æ•°: $(grep -c '^#EXTINF' NonCCTV_final.m3u)"
        
        # 13. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        rm -f Base1.m3u Base_deduped.m3u CCTV_base.m3u NonCCTV_base.m3u \
              CCTV_normalized.m3u NonCCTV_normalized.m3u \
              CCTV_filtered.m3u NonCCTV_filtered.m3u \
              CCTV_final.m3u NonCCTV_final.m3u
        
    - name: Update README
      run: |
        echo -e "# ğŸš€ IPTV è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ\n\n" > README.md
        echo -e "## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯" >> README.md
        echo -e "- **æœ€åæ›´æ–°**: ${{ steps.date.outputs.date }}" >> README.md
        echo -e "- **M3Ué¢‘é“æ•°**: $(grep -c '^#EXTINF' MiGu.m3u || echo 'N/A')" >> README.md
        echo -e "- **TXTé¢‘é“æ•°**: $(wc -l < MiGu.txt 2>/dev/null || echo 'N/A')" >> README.md
        echo -e "\n## ğŸ“ æ–‡ä»¶ä¸‹è½½" >> README.md
        echo -e "- [M3Uæ’­æ”¾åˆ—è¡¨](MiGu.m3u) - æ ‡å‡†IPTVæ ¼å¼" >> README.md
        echo -e "- [TXTæ’­æ”¾åˆ—è¡¨](MiGu.txt) - ç®€æ´æ–‡æœ¬æ ¼å¼" >> README.md
        echo -e "\n## ğŸ”§ æ›´æ–°é¢‘ç‡" >> README.md
        echo -e "æ¯2å°æ—¶è‡ªåŠ¨æ›´æ–°ä¸€æ¬¡ï¼Œä¿è¯æºçš„æ—¶æ•ˆæ€§" >> README.md
        echo -e "\n## ğŸ“ è¯´æ˜" >> README.md
        echo -e "1. è‡ªåŠ¨å»é‡å¤„ç†ï¼Œå»é™¤é‡å¤é¢‘é“å’Œæ— æ•ˆé“¾æ¥" >> README.md
        echo -e "2. é»‘åå•è¿‡æ»¤ï¼Œç§»é™¤è¿è§„å†…å®¹" >> README.md
        echo -e "3. é¢‘é“åˆ†ç±»ï¼ŒCCTVå’Œå…¶ä»–é¢‘é“åˆ†å¼€å¤„ç†" >> README.md
        
    - name: Verify Files
      run: |
        echo "======= æ–‡ä»¶éªŒè¯ ======="
        ls -la MiGu.*
        echo ""
        echo "M3Uæ–‡ä»¶å¤´:"
        head -5 MiGu.m3u
        echo ""
        echo "TXTæ–‡ä»¶ç¤ºä¾‹:"
        head -3 MiGu.txt
        echo ""
        echo "M3Uæ–‡ä»¶å°¾:"
        tail -5 MiGu.m3u
        
    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜åŒ–
        if [[ -n "$(git status --porcelain MiGu.m3u MiGu.txt README.md 2>/dev/null)" ]]; then
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œæ­£åœ¨æäº¤..."
          git add MiGu.m3u MiGu.txt README.md
          git commit -m "ğŸ¯ è‡ªåŠ¨æ›´æ–° [${{ steps.date.outputs.date }}] | é¢‘é“æ•°: $(grep -c '^#EXTINF' MiGu.m3u 2>/dev/null || echo 0)"
        else
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        fi
        
    - name: Push Update
      run: |
        # è®¾ç½®pushç­–ç•¥
        git config push.default simple
        # å¼ºåˆ¶æ¨é€åˆ°å½“å‰åˆ†æ”¯
        git push origin HEAD:${{ github.ref }} --force-with-lease
