name: MiGu Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */2 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Get Time and Date
      id: date
      run: |
        echo "date=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
        echo "tz=$TZ" >> $GITHUB_OUTPUT

    - name: Update Files
      run: |
        # Set locale to avoid warnings
        export LC_ALL=C
        
        # Download base source file
        wget -q "https://bc.188766.xyz/?ip=" -O Base1.m3u
        
        # Merge and deduplicate the base source
        awk '!seen[$0]++' Base1.m3u > Base.m3u
        
        # Process CNTV (non-CCTV) sources with filtering
        awk '
          # Skip empty lines and comments first
          /^\#EXTM3U/ { getline; next }
          /^\#/ { flag=0; next }
          {!flag && $0 !~ /#/} {flag=1}
          
          # Process each channel entry
          flag && /^\#EXTINF/ {
            # Skip lines with specific tvg-id
            if ($0 !~ /tvg-id="å…è´¹åˆ†äº«"/ && $0 !~ /tvg-id="è¯·å‹¿ä¸Šå½“"/) {
              # Process the channel entry
              print $0;
              # Get the URL line
              getline;
              # Only keep if it's a URL (not a comment)
              if ($0 !~ /^#/) {
                print $0;
              }
            }
          }
          # Include other lines normally
          {
            #
          }
        ' Base.m3u > CNTV.m3u
        
        # Process CCTV sources separately
        awk '
          # Skip empty lines and comments first
          /^\#EXTM3U/ { getline; next }
          /^\#/ { flag=0; next }
          {!flag && $0 !~ /#/} {flag=1}
          
          # Process each channel entry
          flag && /^\#EXTINF/ {
            # Keep CCTV channels only
            if ($0 !~ /tvg-id="å…è´¹åˆ†äº«"/ && $0 !~ /tvg-id="è¯·å‹¿ä¸Šå½“"/) {
              print $0
              getline
              print $0
            }
          }
        ' Base.m3u > CCTV.m3u
        
        # Create the final M3U playlist
        {
          echo '#EXTM3U x-tvg-url="https://itv.sspai.dpdns.org/epg.xml" catchup="append" catchup-source="?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}"'
          echo '#EXTINF:-1 tvg-id="æ¸©é¦¨æç¤º" tvg-name="æ¸©é¦¨æç¤º" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/æ¸©é¦¨æç¤º.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",æ¸©é¦¨æç¤º'
          echo 'https://cloudflare.tv/hls/live.m3u8'
          echo '#EXTINF:-1 tvg-id="è°¨é˜²è¯ˆéª—" tvg-name="è°¨é˜²è¯ˆéª—" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/è°¨é˜²è¯ˆéª—.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",è°¨é˜²è¯ˆéª—'
          echo 'https://cloudflare.tv/hls/live.m3u8'
          echo '#EXTINF:-1 tvg-id="ç¦æ­¢è•‰ç»¿" tvg-name="ç¦æ­¢è•‰ç»¿" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/ç¦æ­¢è•‰ç»¿.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",ç¦æ­¢è•‰ç»¿'
          echo 'https://cloudflare.tv/hls/live.m3u8'
          cat CCTV.m3u CNTV.m3u
        } > MiGu.m3u
        
        # Generate TXT playlist
        awk 'tolower($0) ~ /#extinf/{ 
            split($0, a, ",");
            name = a[2];
            getline url;
            gsub(/\r/, "", name);
            gsub(/\r/, "", url);
            sub(/^ /, "", name);
            print name "," url;
          }' MiGu.m3u | awk '!seen[$0]++' > MiGu.txt
        
        # Clean up intermediate files
        rm -f Base1.m3u Base.m3u CCTV.m3u CNTV.m3u

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add files and commit
        git add MiGu.m3u MiGu.txt
        git add README.md
        
        # Set commit message with date
        git commit -m "Updated IPTV playlist on $(date -u +"%Y-%m-%d %H:%M:%S UTC")" -m "Generated by GitHub Actions"

    - name: Push Update
      run: |
        git push
