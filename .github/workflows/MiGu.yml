name: MiGu Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */2 * * *'

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Get Time and Date
      id: date
      run: |
        echo "date=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_OUTPUT
        echo "tz=$TZ" >> $GITHUB_OUTPUT

    - name: Update Files
      run: |
        # Set locale to avoid warnings
        export LC_ALL=C
        
        # Download base source file
        wget -q "https://bc.188766.xyz/?ip=" -O Base1.m3u
        
        # Merge and deduplicate the base source
        awk '!seen[$0]++' Base1.m3u > Base.m3u
        
        # Create the initial M3U header
        echo '#EXTM3U' > MiGu.m3u
    
    - name: Add Custom Group
      run: |
        echo '#EXTINF:-1 tvg-id="æ¸©é¦¨æç¤º" tvg-name="æ¸©é¦¨æç¤º" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/æ¸©é¦¨æç¤º.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",æ¸©é¦¨æç¤º' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u
        
        echo '#EXTINF:-1 tvg-id="è°¨é˜²è¯ˆéª—" tvg-name="è°¨é˜²è¯ˆéª—" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/è°¨é˜²è¯ˆéª—.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",è°¨é˜²è¯ˆéª—' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u
        
        echo '#EXTINF:-1 tvg-id="ç¦æ­¢è•‰ç»¿" tvg-name="ç¦æ­¢è•‰ç»¿" tvg-logo="https://logo.jsdelivr.dpdns.org/tv/ç¦æ­¢è•‰ç»¿.png" group-title="ðŸ¦§æ¸©é¦¨æç¤º",ç¦æ­¢è•‰ç»¿' >> MiGu.m3u
        echo 'https://cloudflare.tv/hls/live.m3u8' >> MiGu.m3u

    - name: Process Sources
      run: |
        # Process CCTV sources
        awk '
          /^\#EXTM3U/ { next }
          /^\#/ { print; next }
          /å¤®è§†/ {
            print $0;
            getline;
            print $0;
          }
        ' Base.m3u >> MiGu.m3u
        
        # Process non-CCTV sources (filtered)
        awk '
          /^\#EXTM3U/ { next }
          /^\#/ { print; next }
          
          # Skip lines with specific tvg-id
          !/tvg-id="å…è´¹åˆ†äº«"/ && !/tvg-id="è¯·å‹¿ä¸Šå½“"/ {
            if (/å¤®è§†/) {
              print;
            } else {
              print > "CNTV.tmp"
            }
          }
        ' Base.m3u
        
        # Append filtered non-CCTV sources
        cat CNTV.tmp >> MiGu.m3u
        
        # Clean up
        rm -f CNTV.tmp

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Add files and commit
        git add MiGu.m3u
        
        # Update README with current date
        CURRENT_DATE=$(date +"%Y-%m-%d %H:%M:%S UTC")
        echo -e "# IPTV è‡ªåŠ¨æ›´æ–°\n\n### æ›´æ–°äºŽ $CURRENT_DATE\n\n### åŒ…å«æ ¼å¼:\\n- [M3Uæ’­æ”¾åˆ—è¡¨](MiGu.m3u)ï¼ˆMiGu.M3Uï¼‰\\n- [TXTæ’­æ”¾åˆ—è¡¨](MiGu.txt)ï¼ˆMiGu.TXTï¼‰" > README.md
        git add README.md
        
        git commit -m "Updated IPTV playlist on $CURRENT_DATE" -m "Generated by GitHub Actions"

    - name: Push Update
      run: |
        git push
