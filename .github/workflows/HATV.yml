name: HATV Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */9 * * *'  # ÊØè9Â∞èÊó∂ËøêË°å

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: GetTime
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Update Files
      run: |
        # ‰∏ãËΩΩÂü∫Á°ÄÊ∫êÊñá‰ª∂
        wget -q https://live.hacks.tools/tv/ipv4/categories/Â§ÆËßÜÈ¢ëÈÅì.m3u -O Base1.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Âç´ËßÜÈ¢ëÈÅì.m3u -O Base2.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Âú∞ÊñπÈ¢ëÈÅì.m3u -O Base3.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/È¶ôÊ∏ØÈ¢ëÈÅì.m3u -O Base4.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Êæ≥Èó®È¢ëÈÅì.m3u -O Base5.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Âè∞ÊπæÈ¢ëÈÅì.m3u -O Base6.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Ëß£ËØ¥È¢ëÈÅì.m3u -O Base7.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ÁîµÂΩ±È¢ëÈÅì.m3u -O Base8.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ÁªºËâ∫È¢ëÈÅì.m3u -O Base9.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ÂÑøÁ´•È¢ëÈÅì.m3u -O Base10.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Á∫™ÂΩïÈ¢ëÈÅì.m3u -O Base11.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Êï∞Â≠óÈ¢ëÈÅì.m3u -O Base12.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/‰ΩìËÇ≤È¢ëÈÅì.m3u -O Base13.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ÊàèÊõ≤È¢ëÈÅì.m3u -O Base14.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Èü≥‰πêÈ¢ëÈÅì.m3u -O Base15.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Ê∏∏ÊàèÈ¢ëÈÅì.m3u -O Base16.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Áõ¥Êí≠‰∏≠ÂõΩ.m3u -O Base17.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/Êò•ÊôöÈ¢ëÈÅì.m3u -O Base18.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ÂÖ∂‰ªñÈ¢ëÈÅì.m3u -O Base19.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/Â§ÆËßÜÈ¢ëÈÅì.m3u -O Base20.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/Âç´ËßÜÈ¢ëÈÅì.m3u -O Base21.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/Âú∞ÊñπÈ¢ëÈÅì.m3u -O Base22.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/ÁîµÂΩ±È¢ëÈÅì.m3u -O Base23.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/ÂÑøÁ´•È¢ëÈÅì.m3u -O Base24.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/‰ΩìËÇ≤È¢ëÈÅì.m3u -O Base25.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/ÂÖ∂‰ªñÈ¢ëÈÅì.m3u -O Base26.m3u
        
        # ÂêàÂπ∂Âπ∂ÂéªÈáçÂü∫Á°ÄÊ∫ê
        cat Base1.m3u Base2.m3u Base3.m3u Base4.m3u Base5.m3u Base6.m3u Base7.m3u Base8.m3u Base9.m3u Base10.m3u Base11.m3u Base12.m3u Base13.m3u Base14.m3u Base15.m3u Base16.m3u Base17.m3u Base18.m3u Base19.m3u Base20.m3u Base21.m3u Base22.m3u Base23.m3u Base24.m3u Base25.m3u Base26.m3u | awk '!seen[$0]++' > Base.m3u
        
        # Â§ÑÁêÜÂ§ÆËßÜÊ∫ê
        grep -A 1 'Â§ÆËßÜ' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > CCTV.m3u
        
        # Â§ÑÁêÜÈùûÂ§ÆËßÜÊ∫ê
        grep -v -A 1 'Â§ÆËßÜ' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > CNTV.m3u
        
        # ÁîüÊàêÊúÄÁªàM3U
        echo '#EXTM3U x-tvg-url="https://itv.jsdelivr.dpdns.org/epg.xml" catchup="append" catchup-source="?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}"' >HATV.m3u
        
        # Ê∑ªÂä†Ëá™ÂÆö‰πâÊèêÁ§∫ (Ê∏©È¶®ÊèêÁ§∫)
        echo '#EXTINF:-1 tvg-id="Ê∏©È¶®ÊèêÁ§∫" tvg-name="Ê∏©È¶®ÊèêÁ§∫" tvg-logo="https://logo.5iclub.dpdns.org/tv/Ê∏©È¶®ÊèêÁ§∫.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Ê∏©È¶®ÊèêÁ§∫' >>HATV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >>HATV.m3u
        
        # Ê∑ªÂä†Êñ∞Â¢ûÊèêÁ§∫ (Ë∞®Èò≤ËØàÈ™ó)
        echo '#EXTINF:-1 tvg-id="Ë∞®Èò≤ËØàÈ™ó" tvg-name="Ë∞®Èò≤ËØàÈ™ó" tvg-logo="https://logo.5iclub.dpdns.org/tv/Ë∞®Èò≤ËØàÈ™ó.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Ë∞®Èò≤ËØàÈ™ó' >>HATV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >>HATV.m3u
        
        # Ê∑ªÂä†Êñ∞Â¢ûÊèêÁ§∫ (Á¶ÅÊ≠¢ËïâÁªø)
        echo '#EXTINF:-1 tvg-id="Á¶ÅÊ≠¢ËïâÁªø" tvg-name="Á¶ÅÊ≠¢ËïâÁªø" tvg-logo="https://logo.5iclub.dpdns.org/tv/Á¶ÅÊ≠¢ËïâÁªø.png" group-title="ü¶ßÊ∏©È¶®ÊèêÁ§∫",Á¶ÅÊ≠¢ËïâÁªø' >>HATV.m3u
        echo 'https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4' >>HATV.m3u
        
        # ÂêàÂπ∂Ê∫êÊñá‰ª∂
        cat CCTV.m3u CNTV.m3u >>HATV.m3u
        
        # ÁîüÊàêTXTÊí≠ÊîæÂàóË°®
        awk '/^#EXTINF:/ {
            split($0, a, ",");
            name = a[2];
            getline url;
            gsub(/\r/, "", name);
            gsub(/\r/, "", url);
            sub(/^ /, "", name);
            print name "," url;
        }' HATV.m3u | awk '!seen[$0]++' > HATV.txt
        
        # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        rm -f Base.m3u CCTV.m3u CNTV.m3u
        
        # Êõ¥Êñ∞README
        echo -e "# IPTV Ëá™Âä®Êõ¥Êñ∞\n\n### Êõ¥Êñ∞‰∫é ${{ steps.date.outputs.date }}\n\n### ÂåÖÂê´Ê†ºÂºè:\\n- [M3UÊí≠ÊîæÂàóË°®](Internet_iTV.m3u)ÔºàInternet_iTV.M3UÔºâ\\n- [TXTÊí≠ÊîæÂàóË°®](Internet_iTV.txt)ÔºàInternet_iTV.TXTÔºâ\\n- [M3UÊí≠ÊîæÂàóË°®](HATV.m3u)ÔºàHATV.M3UÔºâ\\n- [TXTÊí≠ÊîæÂàóË°®](HATV.txt)ÔºàHATV.TXTÔºâ\\n- [M3UÊí≠ÊîæÂàóË°®](HATV.m3u)ÔºàHATV.M3UÔºâ\\n- [TXTÊí≠ÊîæÂàóË°®](HATV.txt)ÔºàHATV.TXTÔºâ" > README.md

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        # Ê∑ªÂä†Êñá‰ª∂
        git add HATV.m3u HATV.txt README.md

        # Êèê‰∫§Êõ¥Êîπ
        git commit -m "${{ steps.date.outputs.date }}"

    - name: Push Update
      run: git push
