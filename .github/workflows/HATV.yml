name: HATV Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */9 * * *'  # 每9小时运行

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Get Time
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Download Base Files
      run: |
        # 下载M3U文件
        wget -q https://live.hacks.tools/tv/ipv4/categories/央视频道.m3u -O Base1.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/卫视频道.m3u -O Base2.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/地方频道.m3u -O Base3.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/香港频道.m3u -O Base4.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/澳门频道.m3u -O Base5.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/台湾频道.m3u -O Base6.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/解说频道.m3u -O Base7.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/电影频道.m3u -O Base8.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/综艺频道.m3u -O Base9.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/儿童频道.m3u -O Base10.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/纪录频道.m3u -O Base11.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/数字频道.m3u -O Base12.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/体育频道.m3u -O Base13.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/戏曲频道.m3u -O Base14.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/音乐频道.m3u -O Base15.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/游戏频道.m3u -O Base16.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/直播中国.m3u -O Base17.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/春晚频道.m3u -O Base18.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/其他频道.m3u -O Base19.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/央视频道.m3u -O Base20.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/卫视频道.m3u -O Base21.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/地方频道.m3u -O Base22.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/电影频道.m3u -O Base23.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/儿童频道.m3u -O Base24.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/体育频道.m3u -O Base25.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/其他频道.m3u -O Base26.m3u

        # 合并并去重
        cat Base*.m3u | awk '!seen[$0]++' > Base.m3u

    - name: Process CCTV Channels
      run: |
        grep -A 1 '央视' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > CCTV.m3u

    - name: Process Other Channels
      run: |
        grep -v -A 1 '央视' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > Other.m3u

    - name: Generate Final M3U
      run: |
        echo '#EXTM3U x-tvg-url=\"https://itv.jsdelivr.dpdns.org/epg.xml\" catchup=\"append\" catchup-source=\"?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}\"' > HATV.m3u

        # 添加提示信息
        for i in 温暖提示 谨防诈骗 禁止蕉绿；do
          LOGO_URL="https://logo.5iclub.dpdns.org/tv/${i}.png"
          VIDEO_URL="https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4"
          echo '#EXTINF:-1 tvg-id=\"'$i'\" tvg-name=\"'$i'\" tvg-logo=\"'$LOGO_URL'\" group-title=\"🦧温馨提示\",'$i >> HATV.m3u'
          echo $VIDEO_URL >> HATV.m3u
        done

        # 合并频道列表
        cat CCTV.m3u Other.m3u >> HATV.m3u

    - name: Generate TXT Playlist
      run: |
        awk '/^#EXTINF:/ {split($0, a, ","); name=a[2]; getline url; sub(/^ /, "", name); print name","url}' HATV.m3u | awk '!seen[$0]++' > HATV.txt

    - name: Remove Temporary Files
      run: |
        rm -f Base*.m3u Base CCTV Other Other.m3u

    - name: Update README
      run: |
        DATE=$(cat ${{ steps.date.outputs.date}})
        echo "## IPTV 自动更新" > README.md
        echo "### 更新于 $DATE" >> README.md
        echo "### 包含格式:" >> README.md
        echo "- [M3U播放列表](Internet_iTV.m3u)（Internet_iTV.M3U）" >> README.md
        echo "- [TXT播放列表](Internet_iTV.txt)（Internet_iTV.TXT）" >> README.md
        echo "- [M3U播放列表](HATV.m3u)（HATV.M3U）" >> README.md
        echo "- [TXT播放列表](HATV.txt)（HATV.TXT）" >> README.md

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add HATV.m3u HATV.txt README.md

        git commit -m "[Bot] Update IPTV playlist on $DATE"

    - name: Push Update
      run: git push
