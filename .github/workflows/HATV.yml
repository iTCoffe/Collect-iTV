name: HATV Daily Update

on:
  workflow_dispatch:
  watch:
    types: [started]
  schedule:
    - cron: '0 */9 * * *'  # æ¯9å°æ—¶è¿è¡Œ

env:
  TZ: Asia/Shanghai

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Get Time
      id: date
      run: echo "date=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_OUTPUT

    - name: Download Base Files
      run: |
        # ä¸‹è½½M3Uæ–‡ä»¶
        wget -q https://live.hacks.tools/tv/ipv4/categories/å¤®è§†é¢‘é“.m3u -O Base1.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/å«è§†é¢‘é“.m3u -O Base2.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/åœ°æ–¹é¢‘é“.m3u -O Base3.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/é¦™æ¸¯é¢‘é“.m3u -O Base4.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/æ¾³é—¨é¢‘é“.m3u -O Base5.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/å°æ¹¾é¢‘é“.m3u -O Base6.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/è§£è¯´é¢‘é“.m3u -O Base7.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ç”µå½±é¢‘é“.m3u -O Base8.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ç»¼è‰ºé¢‘é“.m3u -O Base9.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/å„¿ç«¥é¢‘é“.m3u -O Base10.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/çºªå½•é¢‘é“.m3u -O Base11.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/æ•°å­—é¢‘é“.m3u -O Base12.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ä½“è‚²é¢‘é“.m3u -O Base13.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/æˆæ›²é¢‘é“.m3u -O Base14.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/éŸ³ä¹é¢‘é“.m3u -O Base15.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/æ¸¸æˆé¢‘é“.m3u -O Base16.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/ç›´æ’­ä¸­å›½.m3u -O Base17.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/æ˜¥æ™šé¢‘é“.m3u -O Base18.m3u
        wget -q https://live.hacks.tools/tv/ipv4/categories/å…¶ä»–é¢‘é“.m3u -O Base19.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/å¤®è§†é¢‘é“.m3u -O Base20.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/å«è§†é¢‘é“.m3u -O Base21.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/åœ°æ–¹é¢‘é“.m3u -O Base22.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/ç”µå½±é¢‘é“.m3u -O Base23.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/å„¿ç«¥é¢‘é“.m3u -O Base24.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/ä½“è‚²é¢‘é“.m3u -O Base25.m3u
        wget -q https://live.hacks.tools/tv/ipv6/categories/å…¶ä»–é¢‘é“.m3u -O Base26.m3u

        # åˆå¹¶å¹¶åŽ»é‡
        cat Base*.m3u | awk '!seen[$0]++' > Base.m3u

    - name: Process CCTV Channels
      run: |
        grep -A 1 'å¤®è§†' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > CCTV.m3u

    - name: Process Other Channels
      run: |
        grep -v -A 1 'å¤®è§†' Base.m3u | grep -v '^--$' | awk '!seen[$0]++' > Other.m3u

    - name: Generate Final M3U
      run: |
        echo '#EXTM3U x-tvg-url=\"https://itv.jsdelivr.dpdns.org/epg.xml\" catchup=\"append\" catchup-source=\"?playseek=${(b)yyyyMMddHHmmss}-${(e)yyyyMMddHHmmss}\"' > HATV.m3u

        # æ·»åŠ æç¤ºä¿¡æ¯
        for i in æ¸©æš–æç¤º è°¨é˜²è¯ˆéª— ç¦æ­¢è•‰ç»¿ï¼›do
          LOGO_URL="https://logo.5iclub.dpdns.org/tv/${i}.png"
          VIDEO_URL="https://iCloud.5iclub.dpdns.org/video/Disclaimer.mp4"
          echo '#EXTINF:-1 tvg-id=\"'$i'\" tvg-name=\"'$i'\" tvg-logo=\"'$LOGO_URL'\" group-title=\"ðŸ¦§æ¸©é¦¨æç¤º\",'$i >> HATV.m3u'
          echo $VIDEO_URL >> HATV.m3u
        done

        # åˆå¹¶é¢‘é“åˆ—è¡¨
        cat CCTV.m3u Other.m3u >> HATV.m3u

    - name: Generate TXT Playlist
      run: |
        awk '/^#EXTINF:/ {split($0, a, ","); name=a[2]; getline url; sub(/^ /, "", name); print name","url}' HATV.m3u | awk '!seen[$0]++' > HATV.txt

    - name: Remove Temporary Files
      run: |
        rm -f Base*.m3u Base CCTV Other Other.m3u

    - name: Update README
      run: |
        DATE=$(cat ${{ steps.date.outputs.date}})
        echo "## IPTV è‡ªåŠ¨æ›´æ–°" > README.md
        echo "### æ›´æ–°äºŽ $DATE" >> README.md
        echo "### åŒ…å«æ ¼å¼:" >> README.md
        echo "- [M3Uæ’­æ”¾åˆ—è¡¨](Internet_iTV.m3u)ï¼ˆInternet_iTV.M3Uï¼‰" >> README.md
        echo "- [TXTæ’­æ”¾åˆ—è¡¨](Internet_iTV.txt)ï¼ˆInternet_iTV.TXTï¼‰" >> README.md
        echo "- [M3Uæ’­æ”¾åˆ—è¡¨](HATV.m3u)ï¼ˆHATV.M3Uï¼‰" >> README.md
        echo "- [TXTæ’­æ”¾åˆ—è¡¨](HATV.txt)ï¼ˆHATV.TXTï¼‰" >> README.md

    - name: Commit Changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add HATV.m3u HATV.txt README.md

        git commit -m "[Bot] Update IPTV playlist on $DATE"

    - name: Push Update
      run: git push
